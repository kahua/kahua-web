;; -*-Scheme-*-
;; test kahua-web script.
;; $Id: test.scm.in,v 1.7 2006/10/24 09:43:33 yasuyuki Exp $
(use srfi-2)
(use srfi-11)
(use gauche.test)
(use gauche.process)
(use gauche.net)
(use rfc.uri)
(use util.list)
(use text.tree)
(use file.util)
(use kahua)
(use kahua.test.xml)
(use kahua.test.worker)

(test-start "kahua-web")

(define GOSH "##GOSH##")
(define (deb msg) (format "[Debug: ~a]" msg))

(sys-system "rm -rf _tmp _work")
(sys-mkdir "_tmp" #o755)
(sys-mkdir "_work" #o755)
(sys-mkdir "_work/plugins" #o755)
(copy-file "../kahua-web/wiliki.scm"  "_work/plugins/wiliki.scm")
(copy-file "../kahua-web/history.scm"  "_work/plugins/history.scm")
(copy-file "##KAHUA_WORKING##/plugins/allow-module.scm"
           "_work/plugins/allow-module.scm")
(copy-file "##KAHUA_WORKING##/plugins/sendmail.scm"  "_work/plugins/sendmail.scm")
(copy-file "../kahua-web/rss-reader.scm"  "_work/plugins/rss-reader.scm")


(define *config* "./test.conf")

(kahua-init *config*)

;;------------------------------------------------------------
;; Run wiki-iki
(test-section "kahua-server kahua-web.kahua")

(with-worker
 (w `(,GOSH "-I.." "-I##KAHUA_LIB##" "kahua-server.scm" "-c" ,*config*
            "../kahua-web/kahua-web.kahua"))
 (test* "run kahua-web.kahua" #t (worker-running? w))
 )

(test-end)

